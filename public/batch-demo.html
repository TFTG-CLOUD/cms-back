<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batch Processing Demo - Multi-file Processing</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .demo-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .config-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .batch-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .batch-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .batch-card h3 {
            margin-top: 0;
            color: #333;
        }
        .progress-container {
            margin-top: 10px;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease;
        }
        .progress-text {
            text-align: center;
            margin-top: 5px;
            font-size: 12px;
        }
        .file-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background: white;
        }
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .file-item:last-child {
            border-bottom: none;
        }
        .file-info {
            flex: 1;
        }
        .file-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        .status-processing {
            background: #d1ecf1;
            color: #0c5460;
        }
        .status-completed {
            background: #d4edda;
            color: #155724;
        }
        .status-failed {
            background: #f8d7da;
            color: #721c24;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        .log-entry.success {
            color: #28a745;
        }
        .log-entry.error {
            color: #dc3545;
        }
        .log-entry.info {
            color: #007bff;
        }
        .websocket-status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        .ws-connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .ws-disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
            border: 1px solid #ddd;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Batch Processing Demo - Multi-file Processing System</h1>
        
        <div class="config-section">
            <h3>Server Configuration</h3>
            <div class="form-group">
                <label for="serverUrl">Server URL:</label>
                <input type="text" id="serverUrl" value="http://localhost:3000" placeholder="http://localhost:3000">
            </div>
            <div class="form-group">
                <label for="apiKey">API Key:</label>
                <input type="text" id="apiKey" placeholder="Your API Key">
            </div>
            <div class="form-group">
                <label for="apiSecret">API Secret:</label>
                <input type="password" id="apiSecret" placeholder="Your API Secret">
            </div>
            <div class="form-group">
                <label for="cmsId">CMS ID:</label>
                <input type="text" id="cmsId" value="demo-cms-001" placeholder="Your CMS ID">
            </div>
        </div>

        <div id="websocketStatus" class="websocket-status ws-disconnected">
            WebSocket: Disconnected
        </div>

        <div class="demo-section">
            <h3>1. Create Batch Processing Job</h3>
            <div class="form-group">
                <label for="batchName">Batch Name:</label>
                <input type="text" id="batchName" value="Video Processing Batch" placeholder="Enter batch name">
            </div>
            <div class="form-group">
                <label for="batchDescription">Description:</label>
                <textarea id="batchDescription" rows="3" placeholder="Enter batch description">Process multiple video files to 1080p MP4 format</textarea>
            </div>
            <div class="form-group">
                <label for="processingType">Processing Type:</label>
                <select id="processingType">
                    <option value="video-transcode">Video Transcoding</option>
                    <option value="audio-convert">Audio Conversion</option>
                    <option value="image-resize">Image Resize</option>
                </select>
            </div>
            <div class="form-group">
                <label for="outputFormat">Output Format:</label>
                <select id="outputFormat">
                    <option value="mp4">MP4</option>
                    <option value="webm">WebM</option>
                    <option value="mp3">MP3</option>
                    <option value="jpg">JPEG</option>
                </select>
            </div>
            <div class="form-group">
                <label for="quality">Quality:</label>
                <select id="quality">
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                    <option value="low">Low</option>
                </select>
            </div>
            <button onclick="createBatchJob()">Create Batch Job</button>
            <button onclick="connectToServer()">Connect WebSocket</button>
        </div>

        <div class="demo-section">
            <h3>2. Add Files to Batch</h3>
            <div class="form-group">
                <label for="fileSelect">Select Multiple Files:</label>
                <input type="file" id="fileSelect" multiple accept="video/*,audio/*,image/*">
            </div>
            <button onclick="addFilesToBatch()">Add Selected Files</button>
            <button onclick="simulateFileUpload()">Simulate File Upload</button>
            <div id="fileList" class="file-list"></div>
        </div>

        <div class="demo-section">
            <h3>3. Start Batch Processing</h3>
            <button id="startBatchBtn" onclick="startBatchProcessing()" disabled>Start Batch Processing</button>
            <button id="cancelBatchBtn" onclick="cancelBatchProcessing()" disabled>Cancel Batch</button>
            <button onclick="getBatchStats()">Get Statistics</button>
        </div>

        <div class="demo-section">
            <h3>4. Real-time Progress Monitoring</h3>
            <div id="batchOverview" class="batch-overview"></div>
        </div>

        <div class="demo-section">
            <h3>5. CMS Dashboard View</h3>
            <div id="cmsStats" class="stats-grid"></div>
            <button onclick="getCMSActiveBatches()">Get Active Batches</button>
            <button onclick="getCMSStatistics()">Get CMS Statistics</button>
        </div>

        <div class="log" id="log"></div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        let socket = null;
        let currentBatchId = null;
        let batchFiles = [];
        let simulatedFiles = [];

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateWebSocketStatus(connected) {
            const statusDiv = document.getElementById('websocketStatus');
            if (connected) {
                statusDiv.className = 'websocket-status ws-connected';
                statusDiv.textContent = 'WebSocket: Connected';
            } else {
                statusDiv.className = 'websocket-status ws-disconnected';
                statusDiv.textContent = 'WebSocket: Disconnected';
            }
        }

        function connectToServer() {
            const serverUrl = document.getElementById('serverUrl').value;
            const cmsId = document.getElementById('cmsId').value;

            if (!serverUrl || !cmsId) {
                log('Please fill in server URL and CMS ID', 'error');
                return;
            }

            socket = io(serverUrl);
            
            socket.on('connect', () => {
                log('Connected to server', 'success');
                updateWebSocketStatus(true);
                
                // Subscribe to CMS updates
                socket.emit('subscribe-cms', cmsId);
                log(`Subscribed to CMS updates for: ${cmsId}`, 'info');
            });

            socket.on('disconnect', () => {
                log('Disconnected from server', 'error');
                updateWebSocketStatus(false);
            });

            // Listen for batch progress updates
            socket.on('batch-progress', (data) => {
                log(`Batch progress: ${data.batchId} - File ${data.fileId}: ${data.progress}% (${data.status})`, 'info');
                updateBatchProgress(data);
            });

            // Listen for batch started events
            socket.on('batch-started', (data) => {
                log(`Batch started: ${data.batchId}`, 'success');
                updateBatchOverview();
            });

            // Listen for batch completion
            socket.on('batch-completed', (data) => {
                log(`Batch completed: ${data.batchId}`, 'success');
                updateBatchOverview();
            });

            // Listen for CMS batch events
            socket.on('cms-batch-started', (data) => {
                log(`CMS batch started: ${data.name} (${data.totalFiles} files)`, 'info');
                updateCMSDashboard();
            });

            socket.on('cms-batch-completed', (data) => {
                log(`CMS batch completed: ${data.batchId}`, 'success');
                updateCMSDashboard();
            });

            socket.on('cms-batch-cancelled', (data) => {
                log(`CMS batch cancelled: ${data.batchId}`, 'error');
                updateCMSDashboard();
            });
        }

        async function createBatchJob() {
            const serverUrl = document.getElementById('serverUrl').value;
            const apiKey = document.getElementById('apiKey').value;
            const apiSecret = document.getElementById('apiSecret').value;
            const cmsId = document.getElementById('cmsId').value;
            const batchName = document.getElementById('batchName').value;
            const batchDescription = document.getElementById('batchDescription').value;
            const processingType = document.getElementById('processingType').value;
            const outputFormat = document.getElementById('outputFormat').value;
            const quality = document.getElementById('quality').value;

            if (!serverUrl || !apiKey || !apiSecret || !cmsId || !batchName) {
                log('Please fill in all required fields', 'error');
                return;
            }

            try {
                log('Creating batch job...', 'info');

                const response = await fetch(`${serverUrl}/api/batch`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey,
                        'X-API-Secret': apiSecret
                    },
                    body: JSON.stringify({
                        name: batchName,
                        description: batchDescription,
                        cmsId: cmsId,
                        fileIds: [], // Will add files later
                        processingOptions: {
                            type: processingType,
                            parameters: {
                                format: outputFormat,
                                quality: quality
                            }
                        },
                        webhookUrl: `${serverUrl}/webhook-demo`,
                        webhookSecret: 'demo-secret'
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    currentBatchId = result.id;
                    batchFiles = [];
                    log(`Batch job created: ${result.id}`, 'success');
                    document.getElementById('startBatchBtn').disabled = false;
                    document.getElementById('cancelBatchBtn').disabled = false;
                    
                    // Subscribe to batch updates
                    if (socket) {
                        socket.emit('subscribe-batch', result.id);
                    }
                } else {
                    log(`Error creating batch: ${result.error}`, 'error');
                }

            } catch (error) {
                log(`Error: ${error.message}`, 'error');
            }
        }

        function simulateFileUpload() {
            const fileNames = [
                'video1.mp4', 'video2.mp4', 'video3.mp4', 'video4.mp4', 'video5.mp4',
                'video6.mp4', 'video7.mp4', 'video8.mp4', 'video9.mp4', 'video10.mp4'
            ];

            // Simulate 10 files
            simulatedFiles = fileNames.map((name, index) => ({
                id: `file-${index + 1}`,
                name: name,
                size: Math.floor(Math.random() * 100000000) + 10000000, // 10MB - 100MB
                type: 'video/mp4'
            }));

            updateFileList();
            log(`Simulated ${simulatedFiles.length} files for upload`, 'info');
        }

        function updateFileList() {
            const fileListDiv = document.getElementById('fileList');
            fileListDiv.innerHTML = '';

            [...batchFiles, ...simulatedFiles].forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <strong>${file.name}</strong><br>
                        <small>${formatBytes(file.size)} - ${file.type}</small>
                    </div>
                    <div class="file-status status-pending">Pending</div>
                `;
                fileListDiv.appendChild(fileItem);
            });
        }

        async function addFilesToBatch() {
            if (!currentBatchId) {
                log('Please create a batch job first', 'error');
                return;
            }

            const fileSelect = document.getElementById('fileSelect');
            const files = Array.from(fileSelect.files);

            if (files.length === 0 && simulatedFiles.length === 0) {
                log('Please select files or simulate file upload', 'error');
                return;
            }

            try {
                log('Adding files to batch...', 'info');

                // For demo purposes, we'll simulate file IDs
                const fileIds = simulatedFiles.map(file => file.id);
                
                const serverUrl = document.getElementById('serverUrl').value;
                const apiKey = document.getElementById('apiKey').value;
                const apiSecret = document.getElementById('apiSecret').value;

                const response = await fetch(`${serverUrl}/api/batch/${currentBatchId}/files`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey,
                        'X-API-Secret': apiSecret
                    },
                    body: JSON.stringify({
                        fileIds: fileIds
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    batchFiles = [...batchFiles, ...simulatedFiles];
                    log(`Added ${fileIds.length} files to batch`, 'success');
                    updateFileList();
                    updateBatchOverview();
                } else {
                    log(`Error adding files: ${result.error}`, 'error');
                }

            } catch (error) {
                log(`Error: ${error.message}`, 'error');
            }
        }

        async function startBatchProcessing() {
            if (!currentBatchId) {
                log('Please create a batch job first', 'error');
                return;
            }

            try {
                log('Starting batch processing...', 'info');

                const serverUrl = document.getElementById('serverUrl').value;
                const apiKey = document.getElementById('apiKey').value;
                const apiSecret = document.getElementById('apiSecret').value;

                const response = await fetch(`${serverUrl}/api/batch/${currentBatchId}/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey,
                        'X-API-Secret': apiSecret
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    log(`Batch processing started: ${result.id}`, 'success');
                    updateBatchOverview();
                } else {
                    log(`Error starting batch: ${result.error}`, 'error');
                }

            } catch (error) {
                log(`Error: ${error.message}`, 'error');
            }
        }

        async function cancelBatchProcessing() {
            if (!currentBatchId) {
                log('No active batch to cancel', 'error');
                return;
            }

            try {
                log('Cancelling batch processing...', 'info');

                const serverUrl = document.getElementById('serverUrl').value;
                const apiKey = document.getElementById('apiKey').value;
                const apiSecret = document.getElementById('apiSecret').value;

                const response = await fetch(`${serverUrl}/api/batch/${currentBatchId}/cancel`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey,
                        'X-API-Secret': apiSecret
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    log(`Batch cancelled: ${result.id}`, 'success');
                    updateBatchOverview();
                } else {
                    log(`Error cancelling batch: ${result.error}`, 'error');
                }

            } catch (error) {
                log(`Error: ${error.message}`, 'error');
            }
        }

        function updateBatchProgress(data) {
            // Update the specific file progress in the UI
            const fileItems = document.querySelectorAll('.file-item');
            fileItems.forEach(item => {
                const fileName = item.querySelector('strong').textContent;
                if (fileName.includes(data.fileId)) {
                    const statusDiv = item.querySelector('.file-status');
                    statusDiv.className = `file-status status-${data.status}`;
                    statusDiv.textContent = `${data.status} (${data.progress}%)`;
                }
            });

            updateBatchOverview();
        }

        function updateBatchOverview() {
            const overviewDiv = document.getElementById('batchOverview');
            
            if (!currentBatchId) {
                overviewDiv.innerHTML = '<p>No active batch job</p>';
                return;
            }

            // Simulate batch overview for demo
            overviewDiv.innerHTML = `
                <div class="batch-card">
                    <h3>Current Batch</h3>
                    <p><strong>ID:</strong> ${currentBatchId}</p>
                    <p><strong>Total Files:</strong> ${batchFiles.length + simulatedFiles.length}</p>
                    <p><strong>Status:</strong> Processing</p>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 65%"></div>
                        </div>
                        <div class="progress-text">65% Complete</div>
                    </div>
                </div>
                <div class="batch-card">
                    <h3>File Progress</h3>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 80%"></div>
                        </div>
                        <div class="progress-text">8 of 10 files processed</div>
                    </div>
                    <p><strong>Completed:</strong> 8 files</p>
                    <p><strong>Failed:</strong> 0 files</p>
                    <p><strong>Processing:</strong> 2 files</p>
                </div>
            `;
        }

        function updateCMSDashboard() {
            const statsDiv = document.getElementById('cmsStats');
            const cmsId = document.getElementById('cmsId').value;
            
            // Simulate CMS statistics
            statsDiv.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">1</div>
                    <div class="stat-label">Active Batches</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">10</div>
                    <div class="stat-label">Total Files</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">8</div>
                    <div class="stat-label">Processed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">0</div>
                    <div class="stat-label">Failed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">65%</div>
                    <div class="stat-label">Progress</div>
                </div>
            `;
        }

        async function getCMSActiveBatches() {
            const serverUrl = document.getElementById('serverUrl').value;
            const apiKey = document.getElementById('apiKey').value;
            const apiSecret = document.getElementById('apiSecret').value;
            const cmsId = document.getElementById('cmsId').value;

            try {
                const response = await fetch(`${serverUrl}/api/cms/active-batches/${cmsId}`, {
                    headers: {
                        'X-API-Key': apiKey,
                        'X-API-Secret': apiSecret
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    log(`Found ${result.activeBatches.length} active batches`, 'success');
                    console.log('Active batches:', result.activeBatches);
                } else {
                    log(`Error getting active batches: ${result.error}`, 'error');
                }

            } catch (error) {
                log(`Error: ${error.message}`, 'error');
            }
        }

        async function getCMSStatistics() {
            const serverUrl = document.getElementById('serverUrl').value;
            const apiKey = document.getElementById('apiKey').value;
            const apiSecret = document.getElementById('apiSecret').value;
            const cmsId = document.getElementById('cmsId').value;

            try {
                const response = await fetch(`${serverUrl}/api/cms/batch-stats/${cmsId}`, {
                    headers: {
                        'X-API-Key': apiKey,
                        'X-API-Secret': apiSecret
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    log('Retrieved CMS statistics', 'success');
                    console.log('CMS statistics:', result.statistics);
                    updateCMSDashboard();
                } else {
                    log(`Error getting statistics: ${result.error}`, 'error');
                }

            } catch (error) {
                log(`Error: ${error.message}`, 'error');
            }
        }

        async function getBatchStats() {
            if (!currentBatchId) {
                log('No active batch job', 'error');
                return;
            }

            const serverUrl = document.getElementById('serverUrl').value;
            const apiKey = document.getElementById('apiKey').value;
            const apiSecret = document.getElementById('apiSecret').value;

            try {
                const response = await fetch(`${serverUrl}/api/batch/${currentBatchId}`, {
                    headers: {
                        'X-API-Key': apiKey,
                        'X-API-Secret': apiSecret
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    log('Retrieved batch statistics', 'success');
                    console.log('Batch stats:', result);
                    updateBatchOverview();
                } else {
                    log(`Error getting batch stats: ${result.error}`, 'error');
                }

            } catch (error) {
                log(`Error: ${error.message}`, 'error');
            }
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Initialize
        log('Batch Processing Demo loaded', 'info');
        updateCMSDashboard();
        updateBatchOverview();
    </script>
</body>
</html>